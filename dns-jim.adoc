= It's DNS, Jim...
:backend: revealjs
:revealjs_theme: black
:imagesdir: images
:figure-caption!:

image::bones.jpg[Bones,350]

== ... But Not As We Know It

Jim Hague +
mailto:jim.hague@acm.org[jim.hague@acm.org] +
https://twitter.com/banbury_bill[@banbury_bill] +
http://www.sinodun.com[Sinodun Internet Technologies]

[%notitle]
== DoH RFC

....
Internet Engineering Task Force (IETF)                        P. Hoffman
Request for Comments: 8484                                         ICANN
Category: Standards Track                                     P. McManus
ISSN: 2070-1721                                                  Mozilla
                                                            October 2018


                      DNS Queries over HTTPS (DoH)

Abstract

   This document defines a protocol for sending DNS queries and getting
   DNS responses over HTTPS.  Each DNS query-response pair is mapped
   into an HTTP exchange.
....

[.notes]
--
* What I'm going to be talking about.
* But first, we need some background.
--

[%notitle]
== In the beginning...

image::the_beginning.jpg[background,size=cover]

[.notes]
--
* In the beginning, there was the Word, and the Word was RFC1034.
* Thus spake Mockapetris.
--

[%notitle]
== ... was the word.

....
Network Working Group                                     P. Mockapetris
Request for Comments: 1034                                           ISI
Obsoletes: RFCs 882, 883, 973                              November 1987


                 DOMAIN NAMES - CONCEPTS AND FACILITIES



1. STATUS OF THIS MEMO

This RFC is an introduction to the Domain Name System (DNS), and omits
many details which can be found in a companion RFC, "Domain Names -
Implementation and Specification" [RFC-1035].  That RFC assumes that the
reader is familiar with the concepts discussed in this memo.

A subset of DNS functions and data types constitute an official
protocol.  The official protocol includes standard queries and their
responses and most of the Internet class data formats (e.g., host
addresses).
....

[.notes]
--
* The DNS Ur-document.
* Describes a protocol operating over UDP and TCP.
* Not much thought of security or privacy.
--

== DNS

* A consistent namespace used for referring to resources.
* Maintained in a distributed manner.
* Local caching to improve performance.

[.notes]
--
I'm taking a quick tour through the basics
of how DNS works, largely so we can get the terminology.

I'm only looking at items of interest to application devs.
There's a chunk of stuff on server management which I'm
not going to discuss.
--

== The domain namespace
image::domain-hierarchy.png[Domain Hierarchy]

[.notes]
--
Let's look at the namespace first.

The containers outline the division of responsibility for
parts of the namespace. Note that a single zone can have multiple
levels. In the UK, .co.uk and .org.uk are all in one zone.

The top of the tree is the root zone. This has a null name.
Note FQDN ending in '.'.
--

== Delegation of authority
image::delegation-of-authority.png[Delegation of authority]

[.notes]
--
Another view showing delegation of authority. Note the
cross-cutting link to/from verisign.ca.
--

== Root servers

* A fixed list of IPv4 and IPv6 addresses for 13 servers.
** `a.root-servers.net` .. `m.root-servers.net`

[.notes]
--
Fixed set of 13 root server addresses. Why 13?
--

== Root servers operators

* VeriSign, Inc., University of Southern California, Cogent Communications,
  University of Maryland, NASA Ames Research Centre, Internet Systems Consortium, Inc.,
  US Department of Defence, US Army Research Lab, Netnod (Sweden),
  RIPE, ICANN, WIDE Project (Japan)

https://www.iana.org/domains/root/servers[IANA has the details]

[.notes]
--
J root was originally Network Solutions, now taken over by VeriSign.
--

== Recursive servers

* Search the hierarchy to resolve queries
* Cache results and reuse them in future queries
* Typically run by ISP...
* ... or 3rd party, e.g. Google, OpenDNS

== Stub resolver

* Your local name resolution
* Typically using recursive server(s) supplied by DHCP

== A look at the wire

[%notitle]
== Format of a DNS message

.Format of a DNS message
image::dns-message.jpg[A DNS message]

[.notes]
--
The overall format of a DNS message.

OpCodes. 0=Query, 2=Status

Two others for dynamic updates and zone updates.
--

[%notitle]
== Format of a Question section

.Format of a Question section
image::question-format.jpg[Question section format]

[.notes]
--
The QNAME is a series of labels ending label length 0.
Label compression.
--

[%notitle]
== Format of a RR section

.Format of a RR section
image::rr-format.jpg[RR section format]

[.notes]
--
NAME is a series of labels ending label length 0.
--

[%notitle]
== Common RR types

|===
| A | IPv4 address +
| AAAA | IPv6 address +
| MX | SMTP servers for domain
| NS | Name servers for domain
| PTR | Pointer to canonical name (for address)
| SRV | Location of servers providing given service
| TXT | General textual information
| SOA | Start of Authority record for zone
|===

[.notes]
--
Basic set of RR types. There are lots more, many/most are historical relics.
--

== Transmission

[%step]
* DNS uses UDP
* Except when it uses TCP

[.notes]
--
By default DNS uses UDP. However, in IPv4 the minimum MTU
is 576 bytes. Generally 512 bytes is considered maximum for
unfragmentable UDP payload.

So RFC1035 limits DNS replies to 512 bytes. If you go over that,
you may drop back to TCP. In TCP, you send a 2 byte header giving
the length of the DNS message.

Some queries (e.g. NS for .) generate a list of servers; 13
with A records fits into single UDP with some spare
space. There are also 13 gtld servers for .com/.net.

TCP support was only made mandatory in 2011. However, UDP
usage is preferred as much as possible, avoid connection
setup/teardown overhead on servers.

IPv6 has much larger minimum MTU, 1280. So expect more
root servers in the future.
--

[%notitle]
== EDNS0

....
Network Working Group                                            P. Vixie
Request for Comments: 2671                                            ISC
Category: Standards Track                                     August 1999


                  Extension Mechanisms for DNS (EDNS0)

...

Abstract

   The Domain Name System's wire protocol includes a number of fixed
   fields whose range has been or soon will be exhausted and does not
   allow clients to advertise their capabilities to servers.  This
   document describes backward compatible mechanisms for allowing the
   protocol to grow.
....

[.notes]
--
Obsoleted by RFC6891 (2013), which discarded a funky label format.
--

== EDNS0

* Extends RCODE range and number of flags.
* Mechanism to allow larger UDP messages. This is necessary because of an
  increase in DNS RR sizes:
** AAAA records
** Large TXT records
** DNSSEC

[%notitle]
== EDNS0 OPT RR

|===
| NAME | | Always 00
| TYPE | 16 bits | OPT (41)
| CLASS | 16 bits | Sender UDP payload size
| TTL | 32 bits | uint8 extended RCODE
| | | uint8 version (0)
| | | uint16 flags
| RDLEN | 16 bits | Length of RDATA
| RDATA | | Options. Any number of:
| | | uint16 Option Code
| | | uint16 Option length
| | | Option data
|===

[.notes]
--
Extended RCODE is upper 8 bits of extended 12-bit RCODE.

There are currently no officially defined option codes.

The major point of interest is the ability of a sender to indicate the
largest UDP payload size it thinks it will accept.  This allows other
side to try that size and hopefully avoid fallback to TCP.
--

[%notitle]
== DNSSEC

....
Network Working Group                                          R. Arends
Request for Comments: 4033                          Telematica Instituut
Obsoletes: 2535, 3008, 3090, 3445, 3655, 3658,                R. Austein
           3755, 3757, 3845                                          ISC
Updates: 1034, 1035, 2136, 2181, 2308, 3225,                   M. Larson
         3007, 3597, 3226                                       VeriSign
Category: Standards Track                                      D. Massey
                                               Colorado State University
                                                                 S. Rose
                                                                    NIST
                                                              March 2005


               DNS Security Introduction and Requirements

[omitted]

   The Domain Name System Security Extensions (DNSSEC) add data origin
   authentication and data integrity to the Domain Name System.  This
   document introduces these extensions and describes their capabilities
   and limitations.  This document also discusses the services that the
   DNS security extensions do and do not provide.
....

[.notes]
----
DNSSEC first started in 1995. And it took a LONG time to get
pretty right. The current base RFCs published 2005.

And the root zone didn't get signed until 2010.
----

[%notitle]
== The Snowden revelations

image::snowden.jpg[Snowden]

[.notes]
--
* In 2013, Edward Snowden revealed that interception was far more widespread than believed.
--


[%notitle]
== The IETF response

....
Internet Engineering Task Force (IETF)                        S. Farrell
Request for Comments: 7258                        Trinity College Dublin
BCP: 188                                                   H. Tschofenig
Category: Best Current Practice                                 ARM Ltd.
ISSN: 2070-1721                                                 May 2014


                   Pervasive Monitoring Is an Attack

Abstract

   Pervasive monitoring is a technical attack that should be mitigated
   in the design of IETF protocols, where possible.
....

[.notes]
--
* The IETF's response.
--
