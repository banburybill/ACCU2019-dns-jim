= It's DNS, Jim...
:backend: revealjs
:revealjs_theme: black
:imagesdir: images
:figure-caption!:
:customcss: minspace.css

image::bones.jpg[Bones,350]

== ... But Not As We Know It

Jim Hague +
mailto:jim.hague@acm.org[jim.hague@acm.org] +
https://twitter.com/banbury_bill[@banbury_bill] +
http://www.sinodun.com[Sinodun Internet Technologies]

[%notitle]
== Session summary

image::homer-doh.jpg[background,size=cover]

[%notitle]
== DoH RFC

....
Internet Engineering Task Force (IETF)                        P. Hoffman
Request for Comments: 8484                                         ICANN
Category: Standards Track                                     P. McManus
ISSN: 2070-1721                                                  Mozilla
                                                            October 2018


                      DNS Queries over HTTPS (DoH)

Abstract

   This document defines a protocol for sending DNS queries and getting
   DNS responses over HTTPS.  Each DNS query-response pair is mapped
   into an HTTP exchange.
....

[.notes]
--
* What I'm going to be talking about.
* But first, we need some background.
--

[%notitle]
== In the beginning...

image::the_beginning.jpg[background,size=cover]

[.notes]
--
* In the beginning, there was the Word, and the Word was RFC1034.
* Thus spake Mockapetris.
--

[%notitle]
== ... was the word.

....
Network Working Group                                     P. Mockapetris
Request for Comments: 1034                                           ISI
Obsoletes: RFCs 882, 883, 973                              November 1987


                 DOMAIN NAMES - CONCEPTS AND FACILITIES



1. STATUS OF THIS MEMO

This RFC is an introduction to the Domain Name System (DNS), and omits
many details which can be found in a companion RFC, "Domain Names -
Implementation and Specification" [RFC-1035].  That RFC assumes that the
reader is familiar with the concepts discussed in this memo.

A subset of DNS functions and data types constitute an official
protocol.  The official protocol includes standard queries and their
responses and most of the Internet class data formats (e.g., host
addresses).
....

[.notes]
--
* The DNS Ur-document.
* Describes a protocol operating over UDP and TCP.
* Not much thought of security or privacy.
--

== DNS

* A consistent namespace used for referring to resources.
* Maintained in a distributed manner.
* Local caching to improve performance.

[.notes]
--
I'm taking a quick tour through the basics
of how DNS works, largely so we can get the terminology.

I'm only looking at items of interest to application devs.
There's a chunk of stuff on server management which I'm
not going to discuss.
--

== The domain namespace
image::domain-hierarchy.png[Domain Hierarchy]

[.notes]
--
Let's look at the namespace first.

The containers outline the division of responsibility for
parts of the namespace. Note that a single zone can have multiple
levels. In the UK, .co.uk and .org.uk are all in one zone.

The top of the tree is the root zone. This has a null name.
Note FQDN ending in '.'.
--

== Delegation of authority
image::delegation-of-authority.png[Delegation of authority]

[.notes]
--
Another view showing delegation of authority. Note the
cross-cutting link to/from verisign.ca.
--

== Root servers

* A fixed list of IPv4 and IPv6 addresses for 13 servers.
** `a.root-servers.net` .. `m.root-servers.net`

[.notes]
--
Fixed set of 13 root server addresses. Why 13?
--

== Root servers operators

* VeriSign, Inc., University of Southern California, Cogent Communications,
  University of Maryland, NASA Ames Research Centre, Internet Systems Consortium, Inc.,
  US Department of Defence, US Army Research Lab, Netnod (Sweden),
  RIPE, ICANN, WIDE Project (Japan)

https://www.iana.org/domains/root/servers[IANA has the details]

[.notes]
--
J root was originally Network Solutions, now taken over by VeriSign.
--

== Recursive servers

* Search the hierarchy to resolve queries
* Cache results and reuse them in future queries
* Typically run by ISP...
* ... or 3rd party, e.g. Google, OpenDNS

== Stub resolver

* Your local name resolution
* Typically using recursive server(s) supplied by DHCP

== A look at the wire

[%notitle]
== Format of a DNS message

.Format of a DNS message
image::dns-message.jpg[A DNS message]

[.notes]
--
The overall format of a DNS message.

OpCodes. 0=Query, 2=Status

Two others for dynamic updates and zone updates.
--

[%notitle]
== Format of a Question section

.Format of a Question section
image::question-format.jpg[Question section format]

[.notes]
--
The QNAME is a series of labels ending label length 0.
Label compression.
--

[%notitle]
== Format of a RR section

.Format of a RR section
image::rr-format.jpg[RR section format]

[.notes]
--
NAME is a series of labels ending label length 0.
--

[%notitle]
== Common RR types

[.minspace,cols="20,80"]
|===
| A | IPv4 address +
| AAAA | IPv6 address +
| MX | SMTP servers for domain
| NS | Name servers for domain
| PTR | Pointer to canonical name (for address)
| SRV | Location of servers providing given service
| TXT | General textual information
| SOA | Start of Authority record for zone
|===

[.notes]
--
Basic set of RR types. There are lots more, many/most are historical relics.
--

== Transmission

[%step]
* DNS uses UDP
* Except when it uses TCP

[.notes]
--
By default DNS uses UDP. However, in IPv4 the minimum MTU
is 576 bytes. Generally 512 bytes is considered maximum for
unfragmentable UDP payload.

So RFC1035 limits DNS replies to 512 bytes. If you go over that,
you may drop back to TCP. In TCP, you send a 2 byte header giving
the length of the DNS message.

Some queries (e.g. NS for .) generate a list of servers; 13
with A records fits into single UDP with some spare
space. There are also 13 gtld servers for .com/.net.

TCP support was only made mandatory in 2011. However, UDP
usage is preferred as much as possible, avoid connection
setup/teardown overhead on servers.

IPv6 has much larger minimum MTU, 1280. So expect more
root servers in the future.
--

[%notitle]
== EDNS0

....
Network Working Group                                            P. Vixie
Request for Comments: 2671                                            ISC
Category: Standards Track                                     August 1999


                  Extension Mechanisms for DNS (EDNS0)

...

Abstract

   The Domain Name System's wire protocol includes a number of fixed
   fields whose range has been or soon will be exhausted and does not
   allow clients to advertise their capabilities to servers.  This
   document describes backward compatible mechanisms for allowing the
   protocol to grow.
....

[.notes]
--
Obsoleted by RFC6891 (2013), which discarded a funky label format.
--

== EDNS0

* Extends RCODE range and number of flags.
* Mechanism to allow larger UDP messages. This is necessary because of an
  increase in DNS RR sizes:
** AAAA records
** Large TXT records
** DNSSEC

[%notitle]
== EDNS0 OPT RR

[.minspace,cols="15,25,60"]
|===
| NAME | | Always 00
| TYPE | 16 bits | OPT (41)
| CLASS | 16 bits | Sender UDP payload size
| TTL | 32 bits | uint8 extended RCODE
| | | uint8 version (0)
| | | uint16 flags
| RDLEN | 16 bits | Length of RDATA
| RDATA | | Options. Any number of:
| | | uint16 Option Code
| | | uint16 Option length
| | | Option data
|===

[.notes]
--
Extended RCODE is upper 8 bits of extended 12-bit RCODE.

There are currently no officially defined option codes.

The major point of interest is the ability of a sender to indicate the
largest UDP payload size it thinks it will accept.  This allows other
side to try that size and hopefully avoid fallback to TCP.
--

[%notitle]
== DNSSEC

....
Network Working Group                                          R. Arends
Request for Comments: 4033                          Telematica Instituut
Obsoletes: 2535, 3008, 3090, 3445, 3655, 3658,                R. Austein
           3755, 3757, 3845                                          ISC
Updates: 1034, 1035, 2136, 2181, 2308, 3225,                   M. Larson
         3007, 3597, 3226                                       VeriSign
Category: Standards Track                                      D. Massey
                                               Colorado State University
                                                                 S. Rose
                                                                    NIST
                                                              March 2005


               DNS Security Introduction and Requirements

[omitted]

   The Domain Name System Security Extensions (DNSSEC) add data origin
   authentication and data integrity to the Domain Name System.  This
   document introduces these extensions and describes their capabilities
   and limitations.  This document also discusses the services that the
   DNS security extensions do and do not provide.
....

[.notes]
--
DNSSEC first started in 1995. And it took a LONG time to get
pretty right. The current base RFCs published 2005.

And the root zone didn't get signed until 2010.
--

== DNSSEC

* Assures authenticity of DNS data
* Assures integrity of DNS data
** Note it authenticates DNS data, NOT DNS servers
* Does NOT ensure confidentiality

[.notes]
--
Compare TLS, which authenticates servers not data.
--

[%notitle]
== DNSSEC from root

image:dnsviz1.png[] image:dnsviz2.png[]

[.notes]
--
Note key lengths.
--

[%notitle]
== DNSSEC from root

image::dnsviz3.png[]

== New DNSSEC RRs

* DNSKEY: A public key
* RRSIG: Signature of RR sets
* NSEC/NSEC3: Name existance
* DS: Digest of DNSKEY record on parent side of delegation

== DNSSEC - back to the wire

* EDNS0 flag DO: Client groks DNSSEC.
* New main flags:
** Authenticated Data (AD): Data is authenticated
** Checking Disabled (CD): Client is OK to receive non-authenticated data

== Using DNSSEC

* If your resolver does DNSSEC:
** AD indicates data is authenticated
** SERVFAIL if authentication fails

== Last mile problem

[%step]
* Can your stub resolver validate?
* Can your resolving server validate?
* ... and even if it can, can you trust the link between you and the resolving server?

== Local validation

* DNSSEC-trigger: https://www.nlnetlabs.nl/projects/dnssec-trigger/
* Stubby: https://getdnsapi.net/blog/dns-privacy-daemon-stubby/

== DNSSEC as Public Key infrastructure

[.notes]
--
Putting public keys into DNSSEC gets you a structured,
hierarchical Public Key Infrastructure.

Contrast X.509 structure which is entirely flat.
--

[%notitle]
== DANE and friends

* IPSec keys (RFC4025)
* SSH host keys (RFC4255)
* Storing Certificates, CERT RR (RFC4398)
* DKIM keys (RFC4871)
* CA Authorisation (RFC6844)
* DNS Authentication of Named Entities (DANE), X.509 for TLS (RFC6698,7671)
* OpenPGP key (RFC7929)

[%notitle]
== The Snowden revelations

image::snowden.jpg[Snowden]

[.notes]
--
* In 2013, Edward Snowden revealed that interception was far more widespread than believed.
--

== IETF response - timeline

* 2013:
** Snowden
* 2014:
** RFC7285 Pervasive Monitoring is an Attack
** DPRIVE Working Group formed - goals:
*** Encrypt Stub-Resolver DNS
*** Think about encrypting Resolver-Authoritative

== DPRIVE

* 2015:
** RFC7626 DNS Privacy Considerations
* 2016:
** RFC7766 DNS over TCP
** RFC7858 DNS over TLS

[.notes]
--
RFC7626 is a good read for those interested.

"Alcoholics Anonymouse website is public. The fact you are
reading it is not."

Sara and Stephane may have a bis in the works.
--

[%notitle]
== DNS over TLS (DoT)

....
Internet Engineering Task Force (IETF)                             Z. Hu
Request for Comments: 7858                                        L. Zhu
Category: Standards Track                                   J. Heidemann
ISSN: 2070-1721                                                  USC/ISI
                                                               A. Mankin
                                                             Independent
                                                              D. Wessels
                                                           Verisign Labs
                                                              P. Hoffman
                                                                   ICANN
                                                                May 2016


       Specification for DNS over Transport Layer Security (TLS)

Abstract

   This document describes the use of Transport Layer Security (TLS) to
   provide privacy for DNS.  Encryption provided by TLS eliminates
   opportunities for eavesdropping and on-path tampering with DNS
   queries in the network, such as discussed in RFC 7626.  In addition,
   this document specifies two usage profiles for DNS over TLS and
   provides advice on performance considerations to minimize overhead
   from using TCP and TLS with DNS.
....

== DNS over TLS (DoT)

DNS over TCP, but using TLS and to port 853

[%notitle]
== DoT modes

* Opportunistic mode
** Try 853, fall back to normal DNS on port 53 (Do53?) otherwise
** Defeats passive surveillance
* Strict mode
** Configure server name and verify
** Prevents redirects, increases trust in service
* Transport data integrity - can't inject spoofed responses

[.notes]
--
TCP or TLS prevent amplification attacks.

Note TLS SNI still leaks.
--

== DoT support

* Clients: Android Pie, systemd, Stubby
** Native Windows/macOS/iOS support still needed
* Servers: Unbound, Knot resolver, dnsdist, Bind via proxy
* November 2017: Quad9 public DNS (9.9.9.9)
* March 2018: Cloudflare public DNS (1.1.1.1)
* January 2019: Google public DNS (8.8.8.8)

[.notes]
--
It's easy to run a DoT server. Use one the supported servers, or put a TCP/TLS proxy
in front of any other server.
--
